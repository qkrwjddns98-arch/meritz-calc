<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì•”í†µì¹˜ + ë¹„í†µì¹˜ ìë™ê³„ì‚°ê¸° (UI ì—…ê·¸ë ˆì´ë“œ v3)</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e6002d">

  <link rel="icon" href="icon.png">
  <style>

    .footer-notice {
  margin-top: 30px;
  padding: 12px;
  text-align: center;
  font-size: 13px;
  color: #b30000;
  background: #fff4f4;
  border: 1px solid #ffcccc;
  border-radius: 8px;
  font-weight: 600;
}

    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --muted:#a7adbb;
      --text:#eef1f6;
      --line:#24283a;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --chip:#171a24;
    }
    [data-theme="light"]{
      --bg:#f5f6fa;
      --card:#ffffff;
      --muted:#5b6475;
      --text:#0b1220;
      --line:#e6e8f0;
      --accent:#0ea5e9;
      --accent2:#7c3aed;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --chip:#f3f4f6;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(1200px 600px at 85% 0%, rgba(167,139,250,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      padding: 20px;
    }
    .wrap{max-width: 1100px; margin: 0 auto;}
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom: 14px;
      flex-wrap:wrap;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    h1{font-size: 20px; margin:0; letter-spacing:-.2px}
    .sub{font-size:12px; color:var(--muted); line-height:1.45}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 13px;
      box-shadow: var(--shadow);
      transition: transform .06s ease, border-color .2s ease, background .2s ease, opacity .2s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--line));
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 22%, transparent), rgba(255,255,255,.02));
    }
    .btn.ghost{box-shadow:none; background:transparent;}
    .pill{
      border:1px solid var(--line);
      color:var(--muted);
      padding: 7px 10px;
      border-radius: 999px;
      font-size:12px;
      background: rgba(255,255,255,.03);
    }

    .grid{display:grid; grid-template-columns: 1fr; gap: 12px;}
    .card{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{padding: 14px;}
    .card-head{
      padding: 14px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
      flex-wrap:wrap;
    }
    .card-title{font-weight:800; font-size:14px; letter-spacing:-.2px}
    .card-meta{color:var(--muted); font-size:12px}

    .controls{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 900px){
      .controls{grid-template-columns: 1fr 1fr;}
      .actions{justify-content:flex-start}
    }
    @media (max-width: 520px){
      .controls{grid-template-columns: 1fr;}
    }
    .field{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:var(--muted)}
    select, input{
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder{color: color-mix(in srgb, var(--muted) 70%, transparent)}

    details{border-top:1px solid var(--line);}
    summary{
      cursor:pointer;
      padding: 12px 14px;
      color: var(--muted);
      font-size: 12px;
      list-style:none;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    details .content{padding: 0 14px 14px; color:var(--muted); font-size:12px; line-height:1.55}

    .summarybar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-top: 1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .kbd{border:1px solid var(--line); padding:2px 6px; border-radius:6px; font-size:11px; color:var(--muted);}

    /* Tags */
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.02);
      margin-left: 8px;
    }
    .tag.max{border-color: color-mix(in srgb, var(--accent) 45%, var(--line)); color: color-mix(in srgb, var(--accent) 70%, var(--text));}
    .tag.each{border-color: color-mix(in srgb, var(--accent2) 45%, var(--line)); color: color-mix(in srgb, var(--accent2) 70%, var(--text));}

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: var(--chip);
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 14px;
      font-size:12px;
    }
    .chip b{color:var(--text)}

    /* View toggle (segmented) */
    .seg{
      display:inline-flex;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .seg button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 8px 10px;
      cursor:pointer;
      font-size:12px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }
    .seg button + button{border-left:1px solid var(--line);}
    .seg button.active{
      color: var(--text);
      background: color-mix(in srgb, var(--accent) 14%, transparent);
    }

    /* Desktop table */
    .table-wrap{overflow:auto;}
    table{width:100%; border-collapse:collapse; min-width: 860px;}
    thead th{
      position:sticky; top:0;
      background: color-mix(in srgb, var(--card) 92%, transparent);
      backdrop-filter: blur(10px);
      z-index: 2;
      border-bottom: 1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      text-align:right;
      padding: 10px 10px;
      white-space:nowrap;
    }
    thead th:first-child{text-align:left}
    tbody td{
      padding: 12px 10px;
      border-bottom: 1px solid var(--line);
      text-align:right;
      font-size:14px;
      white-space:nowrap;
    }
    tbody td:first-child{text-align:left}
    tbody tr:hover{background: rgba(255,255,255,.03)}
    .num{font-variant-numeric: tabular-nums;}
    .total{font-weight:900; color: color-mix(in srgb, var(--accent) 80%, var(--text));}

    /* Cards */
    .cards{padding: 12px;}
    .cards-grid{display:grid; grid-template-columns: 1fr; gap:10px;}
    .itemcard{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      padding: 12px;
    }
    .item-top{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom: 8px;
    }
    .item-name{font-weight:800; letter-spacing:-.2px;}
    .item-badges{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;}
    .badge{
      font-size:11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .badge.max{border-color: color-mix(in srgb, var(--accent) 45%, var(--line)); color: color-mix(in srgb, var(--accent) 70%, var(--text));}
    .badge.each{border-color: color-mix(in srgb, var(--accent2) 45%, var(--line)); color: color-mix(in srgb, var(--accent2) 70%, var(--text));}

    .kv{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top: 10px;}
    .kv .k{font-size:11px; color:var(--muted)}
    .kv .v{font-size:14px; font-weight:800}
    .kv .v.total{color: color-mix(in srgb, var(--accent) 80%, var(--text));}

    /* Default responsive behavior (AUTO mode):
       - On small width, hide table and show cards. */
    @media (max-width: 680px){
      body[data-view="auto"] .table-wrap{display:none;}
      body[data-view="auto"] .cards{display:block;}
    }
    @media (min-width: 681px){
      body[data-view="auto"] .table-wrap{display:block;}
      body[data-view="auto"] .cards{display:none;}
    }

    /* Forced modes override */
    body[data-view="table"] .table-wrap{display:block;}
    body[data-view="table"] .cards{display:none;}
    body[data-view="cards"] .table-wrap{display:none;}
    body[data-view="cards"] .cards{display:block;}

    .footer{
      margin-top: 12px;
      font-size:12px; color:var(--muted); line-height:1.5;
      text-align:center;
    }
    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      font-size: 12px;
      color: var(--text);
      opacity:0;
      transform: translateY(8px);
      transition: opacity .2s ease, transform .2s ease;
      pointer-events:none;
      max-width: 75vw;
    }
    .toast.show{opacity:1; transform: translateY(0)}
  </style>
</head>
<body data-view="auto">
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="title">
        <h1>ì•”í†µì¹˜(ê¸°ë³¸í˜•/ì‹¤ì†í˜•) + ë¹„í†µì¹˜ í•©ì‚° ê³„ì‚°ê¸°</h1>
        <div class="sub">ë‹¨ìœ„: <b>ë§Œì›</b> Â· í•©ì‚°ê¸ˆì•¡ <b>ë‚´ë¦¼ì°¨ìˆœ</b> Â· ë³´ê¸°ëª¨ë“œ(ìë™/í‘œ/ì¹´ë“œ) ì„ íƒ ê°€ëŠ¥</div>
      </div>
      <div class="actions">
        <span class="pill mono" id="statusPill">Ready</span>
        <button class="btn ghost" id="themeBtn" title="í…Œë§ˆ ì „í™˜"><span>ğŸŒ“</span><span>í…Œë§ˆ</span></button>
        <button class="btn" id="copyBtn" title="ê²°ê³¼ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬"><span>ğŸ“‹</span><span>ë³µì‚¬</span></button>
        <button class="btn primary" id="csvBtn" title="CSVë¡œ ë‹¤ìš´ë¡œë“œ"><span>â¬‡ï¸</span><span>CSV</span></button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">ì„ íƒ</div>
            <div class="card-meta">ê¸°ë³¸í˜•/ì‹¤ì†í˜• + í•œë„ + ë¹„í†µì¹˜</div>
          </div>
          <div class="card-meta mono"><span class="kbd">Enter</span>ë¡œë„ ì¬ê³„ì‚°</div>
        </div>

        <div class="card-inner">
          <div class="controls">
            <div class="field">
              <label>ì•”í†µì¹˜ ìœ í˜•</label>
              <select id="cancerType">
                <option value="basic">ê¸°ë³¸í˜•</option>
                <option value="simple">ì‹¤ì†í˜•</option>
              </select>
            </div>

            <div class="field">
              <label>ì•”í†µì¹˜ í•œë„</label>
              <select id="cancerLimit"></select>
            </div>

            <div class="field">
              <label>ë¹„í†µì¹˜ í•œë„</label>
              <select id="nonLimit"></select>
            </div>

            <div class="field">
              <label>í•­ëª© ê²€ìƒ‰</label>
              <input id="filter" placeholder="ì˜ˆ) ë©´ì—­, ìˆ˜ìˆ , ë‹¤ë¹ˆì¹˜â€¦" />
            </div>
          </div>

          <div class="summarybar">
            <div class="mono" id="summaryText">[ì„ íƒ] -</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end; align-items:center;">
              <span class="tag max">ìµœëŒ€(ë¬¶ìŒ)</span>
              <span class="tag each">ê°ê°/ë§¤íšŒ</span>
              <span class="chip" id="countChip">í‘œì‹œ <b>0</b>ê°œ</span>
              <span class="chip">ì •ë ¬ <b>í•©ì‚°â†“</b></span>

              <div class="seg" title="ë³´ê¸° ëª¨ë“œ">
                <button id="viewAuto" class="active" type="button">âœ¨ ìë™</button>
                <button id="viewTable" type="button">ğŸ“Š í‘œ</button>
                <button id="viewCards" type="button">ğŸƒ ì¹´ë“œ</button>
              </div>
            </div>
          </div>
        </div>

        <details>
          <summary>ê³„ì‚° ê·œì¹™ ë³´ê¸°/ì ‘ê¸°</summary>
          <div class="content">
            <div>â€¢ ë©´ì—­í•­ì•”(ìµœëŒ€)=ë©´ì—­+í‘œì +í•­ì•”ì•½ë¬¼(ì•”)</div>
            <div>â€¢ í‘œì í•­ì•”(ìµœëŒ€)=í‘œì +í•­ì•”ì•½ë¬¼(ì•”)</div>
            <div>â€¢ ì–‘ì„±ì(ìµœëŒ€)=ì–‘ì„±ì+í•­ì•”ë°©ì‚¬ì„ (ì•”)</div>
            <div>â€¢ ë‹¤ë¹ˆì¹˜(ì•”)(ìµœëŒ€)=ë‹¤ë¹ˆì¹˜(ì•”)+ìˆ˜ìˆ (ì•”)</div>
            <div>â€¢ ì„¸ê¸°ì¡°ì ˆ(ìµœëŒ€)=ì„¸ê¸°ì¡°ì ˆ+í•­ì•”ë°©ì‚¬ì„ (ì•”) + (ë¹„í†µì¹˜ í•­ì•”ë°©ì‚¬ì„ (ì•”))</div>
            <div>â€¢ ìˆ˜ìˆ /ë°©ì‚¬ì„ /ì•½ë¬¼ì€ ê°ê°/ë§¤íšŒ ë‹¨ë…ë„ ë³„ë„ í‘œì‹œ</div>
          </div>
        </details>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">ê²°ê³¼</div>
            <div class="card-meta">í•­ëª©ë³„ ì•”í†µì¹˜ + ë¹„í†µì¹˜ = í•©ì‚°</div>
          </div>
          <div class="card-meta mono" id="countText">0ê°œ</div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:42%">í•­ëª©</th>
                <th style="width:19%">ì•”í†µì¹˜</th>
                <th style="width:19%">ë¹„í†µì¹˜</th>
                <th style="width:20%">í•©ì‚°</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="cards">
          <div class="cards-grid" id="cards"></div>
        </div>
      </div>

      <div class="footer">
        ë°ì´í„° ê¸°ì¤€: ì•”í†µì¹˜ ê¸°ë³¸í˜•(ì—° 4ì²œ/8ì²œ/1ì–µ) Â· ì•”í†µì¹˜ ì‹¤ì†í˜•(ì—° 7ì²œ/5ì²œ/3ì²œ/1ì²œ) Â· ë¹„í†µì¹˜ ê³ ê¸‰í˜•(ì—° 1ì–µ/7ì²œ/4ì²œ)
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** ë°ì´í„° í…Œì´ë¸” (ë‹¨ìœ„: ë§Œì›) */
const CANCER_BASIC = {
  "4ì²œ": { immune: 1000, target: 1000, proton: 1000, davinci_cancer: 500,
           surgery_cancer: 500, radiation_cancer: 500, radiation_minor: 100,
           drug_cancer: 500, drug_minor: 100, intensity: 500 },
  "8ì²œ": { immune: 2000, target: 2000, proton: 2000, davinci_cancer: 750,
           surgery_cancer: 750, radiation_cancer: 750, radiation_minor: 150,
           drug_cancer: 750, drug_minor: 150, intensity: 750 },
  "1ì–µ": { immune: 3000, target: 3000, proton: 3000, davinci_cancer: 1000,
           surgery_cancer: 1000, radiation_cancer: 1000, radiation_minor: 200,
           drug_cancer: 1000, drug_minor: 200, intensity: 1000 } };
const CANCER_SIMPLE = {
  "7ì²œ": { immune: 1000, target: 1000, proton: 1000,
           surgery_cancer: 1000, radiation_cancer: 1000, radiation_minor: 200,
           drug_cancer: 1000, drug_minor: 200, intensity: 0, davinci_cancer: 0 },
  "5ì²œ": { immune: 750, target: 750, proton: 750,
           surgery_cancer: 750, radiation_cancer: 750, radiation_minor: 150,
           drug_cancer: 750, drug_minor: 150, intensity: 0, davinci_cancer: 0 },
  "3ì²œ": { immune: 500, target: 500, proton: 500,
           surgery_cancer: 500, radiation_cancer: 500, radiation_minor: 100,
           drug_cancer: 500, drug_minor: 100, intensity: 0, davinci_cancer: 0 },
  "1ì²œ": { immune: 250, target: 250, proton: 250,
           surgery_cancer: 250, radiation_cancer: 250, radiation_minor: 50,
           drug_cancer: 250, drug_minor: 50, intensity: 0, davinci_cancer: 0 } };
const NON_TREAT = {
  "1ì–µ": { immune: 3000, target: 3000, proton: 3000, davinci_cancer: 1000,
           surgery_cancer: 1000, radiation_cancer: 1000, radiation_minor: 200,
           drug_cancer: 1000, drug_minor: 200, intensity: 0 },
  "7ì²œ": { immune: 2000, target: 2000, proton: 2000, davinci_cancer: 750,
           surgery_cancer: 750, radiation_cancer: 750, radiation_minor: 150,
           drug_cancer: 750, drug_minor: 150, intensity: 0 },
  "4ì²œ": { immune: 1000, target: 1000, proton: 1000, davinci_cancer: 500,
           surgery_cancer: 500, radiation_cancer: 500, radiation_minor: 100,
           drug_cancer: 500, drug_minor: 100, intensity: 0 } };
const ORDER = [
  { key:"ë©´ì—­í•­ì•”(ìµœëŒ€)", type:"max" },
  { key:"í‘œì í•­ì•”(ìµœëŒ€)", type:"max" },
  { key:"ì–‘ì„±ì(ìµœëŒ€)", type:"max" },
  { key:"ë‹¤ë¹ˆì¹˜(ì•”)(ìµœëŒ€)", type:"max" },  { key:"ì„¸ê¸°ì¡°ì ˆ(ìµœëŒ€)", type:"max" },
  { key:"ìˆ˜ìˆ (ì•”)(ë§¤íšŒ)", type:"each" },  { key:"í•­ì•”ë°©ì‚¬ì„ (ì•”)(ê°ê°)", type:"each" },
  { key:"í•­ì•”ë°©ì‚¬ì„ (ê¸°íƒ€/ê°‘ìƒì„ )(ê°ê°)", type:"each" },
  { key:"í•­ì•”ì•½ë¬¼(ì•”)(ê°ê°)", type:"each" },
  { key:"í•­ì•”ì•½ë¬¼(ê¸°íƒ€/ê°‘ìƒì„ )(ê°ê°)", type:"each" },
];

function calcAll(c, n) {
  const out = {};
  let cVal, nVal;

  cVal = (c.immune||0) + (c.target||0) + (c.drug_cancer||0);
  nVal = (n.immune||0) + (n.target||0) + (n.drug_cancer||0);
  out["ë©´ì—­í•­ì•”(ìµœëŒ€)"] = [cVal, nVal, cVal+nVal];

  cVal = (c.target||0) + (c.drug_cancer||0);
  nVal = (n.target||0) + (n.drug_cancer||0);
  out["í‘œì í•­ì•”(ìµœëŒ€)"] = [cVal, nVal, cVal+nVal];

  cVal = (c.proton||0) + (c.radiation_cancer||0);
  nVal = (n.proton||0) + (n.radiation_cancer||0);
  out["ì–‘ì„±ì(ìµœëŒ€)"] = [cVal, nVal, cVal+nVal];

  cVal = (c.davinci_cancer||0) + (c.surgery_cancer||0);
  nVal = (n.davinci_cancer||0) + (n.surgery_cancer||0);
  out["ë‹¤ë¹ˆì¹˜(ì•”)(ìµœëŒ€)"] = [cVal, nVal, cVal+nVal];

  cVal = (c.intensity||0) + (c.radiation_cancer||0);
  nVal = (n.radiation_cancer||0);
  out["ì„¸ê¸°ì¡°ì ˆ(ìµœëŒ€)"] = [cVal, nVal, cVal+nVal];

  out["ìˆ˜ìˆ (ì•”)(ë§¤íšŒ)"] = [(c.surgery_cancer||0), (n.surgery_cancer||0), (c.surgery_cancer||0)+(n.surgery_cancer||0)];
  out["í•­ì•”ë°©ì‚¬ì„ (ì•”)(ê°ê°)"] = [(c.radiation_cancer||0), (n.radiation_cancer||0), (c.radiation_cancer||0)+(n.radiation_cancer||0)];
  out["í•­ì•”ë°©ì‚¬ì„ (ê¸°íƒ€/ê°‘ìƒì„ )(ê°ê°)"] = [(c.radiation_minor||0), (n.radiation_minor||0), (c.radiation_minor||0)+(n.radiation_minor||0)];
  out["í•­ì•”ì•½ë¬¼(ì•”)(ê°ê°)"] = [(c.drug_cancer||0), (n.drug_cancer||0), (c.drug_cancer||0)+(n.drug_cancer||0)];
  out["í•­ì•”ì•½ë¬¼(ê¸°íƒ€/ê°‘ìƒì„ )(ê°ê°)"] = [(c.drug_minor||0), (n.drug_minor||0), (c.drug_minor||0)+(n.drug_minor||0)];

  return out;
}

// ===== UI wiring =====
const els = {
  status: document.getElementById("statusPill"),
  themeBtn: document.getElementById("themeBtn"),
  copyBtn: document.getElementById("copyBtn"),
  csvBtn: document.getElementById("csvBtn"),
  cancerType: document.getElementById("cancerType"),
  cancerLimit: document.getElementById("cancerLimit"),
  nonLimit: document.getElementById("nonLimit"),
  filter: document.getElementById("filter"),
  tbody: document.getElementById("tbody"),
  cards: document.getElementById("cards"),
  summaryText: document.getElementById("summaryText"),
  countText: document.getElementById("countText"),
  countChip: document.getElementById("countChip"),
  toast: document.getElementById("toast"),
  viewAuto: document.getElementById("viewAuto"),
  viewTable: document.getElementById("viewTable"),
  viewCards: document.getElementById("viewCards") };

function fillSelect(el, values) {
  el.innerHTML = "";
  values.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    el.appendChild(opt);
  });
}
function refreshLimits() {
  const t = els.cancerType.value;
  fillSelect(els.cancerLimit, t === "basic" ? Object.keys(CANCER_BASIC) : Object.keys(CANCER_SIMPLE));
  fillSelect(els.nonLimit, Object.keys(NON_TREAT));
}
function fmt(n){ return (n||0).toLocaleString("ko-KR"); }
function toast(msg){
  els.toast.textContent = msg;
  els.toast.classList.add("show");
  setTimeout(()=>els.toast.classList.remove("show"), 1600);
}
function getState(){
  const planType = els.cancerType.value;
  const cLimit = els.cancerLimit.value;
  const nLimit = els.nonLimit.value;
  const planName = planType === "basic" ? "ê¸°ë³¸í˜•" : "ì‹¤ì†í˜•";
  const cancer = planType === "basic" ? CANCER_BASIC[cLimit] : CANCER_SIMPLE[cLimit];
  const non = NON_TREAT[nLimit];
  return { planType, planName, cLimit, nLimit, cancer, non };
}
function buildRows(results, filterText){
  const f = (filterText||"").trim().toLowerCase();
  const rows = [];
  ORDER.forEach(({key, type})=>{
    const [cAmt, nAmt, total] = results[key];
    if (f && !key.toLowerCase().includes(f)) return;
    rows.push({ key, type, cAmt, nAmt, total });
  });
  rows.sort((a,b)=> (b.total - a.total)); // í•©ì‚° ë‚´ë¦¼ì°¨ìˆœ
  return rows;
}

function setView(mode){
  // mode: auto | table | cards
  document.body.setAttribute("data-view", mode);
  localStorage.setItem("meritz_view", mode);

  els.viewAuto.classList.toggle("active", mode === "auto");
  els.viewTable.classList.toggle("active", mode === "table");
  els.viewCards.classList.toggle("active", mode === "cards");

  toast(mode === "auto" ? "ë³´ê¸°: ìë™" : (mode === "table" ? "ë³´ê¸°: í‘œ" : "ë³´ê¸°: ì¹´ë“œ"));
}

function render(){
  const { planName, cLimit, nLimit, cancer, non } = getState();
  const results = calcAll(cancer, non);

  els.summaryText.textContent = `[ì„ íƒ] ì•”í†µì¹˜: ${planName} ${cLimit}  |  ë¹„í†µì¹˜: ${nLimit}  (ë‹¨ìœ„: ë§Œì›)`;
  els.status.textContent = "Updated";

  const rows = buildRows(results, els.filter.value);
  els.countText.textContent = `${rows.length}ê°œ`;
  els.countChip.innerHTML = `í‘œì‹œ <b>${rows.length}</b>ê°œ`;

  // table
  els.tbody.innerHTML = "";
  rows.forEach(r=>{
    const tag = r.type === "max"
      ? '<span class="tag max">ìµœëŒ€</span>'
      : '<span class="tag each">ê°ê°/ë§¤íšŒ</span>';

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.key}${tag}</td>
      <td class="num">${fmt(r.cAmt)}</td>
      <td class="num">${fmt(r.nAmt)}</td>
      <td class="num total">${fmt(r.total)}</td>
    `;
    els.tbody.appendChild(tr);
  });

  // cards
  els.cards.innerHTML = "";
  rows.forEach(r=>{
    const badge = r.type === "max"
      ? '<span class="badge max">ìµœëŒ€(ë¬¶ìŒ)</span>'
      : '<span class="badge each">ê°ê°/ë§¤íšŒ</span>';

    const div = document.createElement("div");
    div.className = "itemcard";
    div.innerHTML = `
      <div class="item-top">
        <div class="item-name">${r.key}</div>
        <div class="item-badges">${badge}</div>
      </div>
      <div class="kv">
        <div>
          <div class="k">ì•”í†µì¹˜</div>
          <div class="v num">${fmt(r.cAmt)}</div>
        </div>
        <div>
          <div class="k">ë¹„í†µì¹˜</div>
          <div class="v num">${fmt(r.nAmt)}</div>
        </div>
        <div style="grid-column: 1 / span 2;">
          <div class="k">í•©ì‚°</div>
          <div class="v num total">${fmt(r.total)}</div>
        </div>
      </div>
    `;
    els.cards.appendChild(div);
  });

  window.__last = { rows, planName, cLimit, nLimit };
}

function copyText(){
  if(!window.__last) return;
  const { planName, cLimit, nLimit, rows } = window.__last;
  const lines = [];
  lines.push(`[ì„ íƒ] ì•”í†µì¹˜: ${planName} ${cLimit} | ë¹„í†µì¹˜: ${nLimit} (ë‹¨ìœ„: ë§Œì›)`);
  lines.push("");
  rows.forEach(r=>{
    lines.push(`${r.key} : ì•”í†µì¹˜ ${r.cAmt} + ë¹„í†µì¹˜ ${r.nAmt} = ${r.total}`);
  });
  navigator.clipboard.writeText(lines.join("\n"))
    .then(()=>toast("ë³µì‚¬ ì™„ë£Œ!"))
    .catch(()=>toast("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)"));
}

function downloadCSV(){
  if(!window.__last) return;
  const { planName, cLimit, nLimit, rows } = window.__last;
  const header = ["í•­ëª©","êµ¬ë¶„","ì•”í†µì¹˜","ë¹„í†µì¹˜","í•©ì‚°"];
  const data = rows.map(r=>[
    r.key,
    r.type === "max" ? "ìµœëŒ€(ë¬¶ìŒ)" : "ê°ê°/ë§¤íšŒ",
    r.cAmt,
    r.nAmt,
    r.total
  ]);
  const csv = [header, ...data]
    .map(row => row.map(x => `"${String(x).replaceAll('"','""')}"`).join(","))
    .join("\r\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ì•”í†µì¹˜_${planName}_${cLimit}_ë¹„í†µì¹˜_${nLimit}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("CSV ë‹¤ìš´ë¡œë“œ!");
}

function loadTheme(){
  const saved = localStorage.getItem("meritz_theme");
  if(saved === "light") document.documentElement.setAttribute("data-theme","light");
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme");
  if(cur === "light"){
    document.documentElement.removeAttribute("data-theme");
    localStorage.setItem("meritz_theme","dark");
    toast("ë‹¤í¬ ëª¨ë“œ");
  }else{
    document.documentElement.setAttribute("data-theme","light");
    localStorage.setItem("meritz_theme","light");
    toast("ë¼ì´íŠ¸ ëª¨ë“œ");
  }
}

function initView(){
  const saved = localStorage.getItem("meritz_view");
  const mode = (saved === "table" || saved === "cards" || saved === "auto") ? saved : "auto";
  setView(mode);
  // setView shows toast; suppress initial toast by immediately hiding if first load
  document.getElementById("toast").classList.remove("show");
}

// events
els.themeBtn.addEventListener("click", toggleTheme);
els.copyBtn.addEventListener("click", copyText);
els.csvBtn.addEventListener("click", downloadCSV);

els.viewAuto.addEventListener("click", ()=>setView("auto"));
els.viewTable.addEventListener("click", ()=>setView("table"));
els.viewCards.addEventListener("click", ()=>setView("cards"));

els.cancerType.addEventListener("change", ()=>{ refreshLimits(); render(); });
els.cancerLimit.addEventListener("change", render);
els.nonLimit.addEventListener("change", render);
els.filter.addEventListener("input", render);

window.addEventListener("keydown", (e)=>{ if(e.key === "Enter") render(); });

// init
loadTheme();
refreshLimits();
initView();
render();
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

  <div class="footer-notice">
â€»ë³¸ ìë£ŒëŠ” ëª¨ì§‘ì¸ êµìœ¡ìš©ì´ë¯€ë¡œ, ê³ ê° êµë¶€ ë° ì˜¨ë¼ì¸ê²Œì‹œëª©ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤â€»
</div>

</body>
</html>
